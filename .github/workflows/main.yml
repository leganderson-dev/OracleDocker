name: MSSQL Init Container

on:
  push:
    branches: [main]

jobs:
  mssql-init:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build MSSQL Docker image
        run: docker build -t mssql-init .

      - name: Run MSSQL container
        run: |
          docker run -d --name mssql-init \
            -e 'ACCEPT_EULA=Y' \
            -e 'SA_PASSWORD=Redg@te1' \
            -p 1433:1433 \
            mssql-init

      - name: Wait for SQL Server to be ready
        run: |
          echo "Waiting for SQL Server to start..."
          for i in {1..30}; do
            docker exec mssql-init /opt/mssql-tools/bin/sqlcmd \
              -S localhost -U SA -P 'Redg@te1' -Q "SELECT 1" && break
            sleep 5
          done

      - name: Show SQL Server logs
        run: docker logs mssql-init
