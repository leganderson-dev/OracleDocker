name: MSSQL-Restore-Bak

on:
  push:
    branches:
    - main

jobs:
  restore-mssql:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build custom MSSQL Docker image
      run: |
        docker build -t custom-mssql-restored .

    - name: Run MSSQL container
      run: |
        docker run -d --name mssql-container \
          -e 'ACCEPT_EULA=Y' \
          -e 'SA_PASSWORD=Redg@te1' \
          -p 1433:1433 \
          custom-mssql-restored

    - name: Wait for SQL Server to be ready
      run: |
        echo "Waiting for SQL Server to be available..."
        for i in {1..30}; do
          docker exec mssql-container /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "Redg@te1" -Q "SELECT name FROM sys.databases" && break
          echo "Retry $i..."
          sleep 5
        done

    - name: Verify database restore
      run: |
        docker exec mssql-container /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U SA -P "Redg@te1" \
          -Q "SELECT name FROM sys.databases WHERE name = 'SSC_Dev'"
