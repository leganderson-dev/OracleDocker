name: MSSQL Init

on:
  push:
    branches:
      - main

jobs:
  init-db:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build MSSQL Docker image
        run: docker build -t mssql-init .

      - name: Run MSSQL container
        run: docker run -d --name mssql -p 1433:1433 mssql-init

      - name: Wait for SQL Server to initialize
        run: |
          echo "Waiting for SQL Server to become ready..."
          for i in {1..30}; do
            if docker exec mssql /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'Redg@te1' -Q "SELECT 1" &>/dev/null; then
              echo "SQL Server is ready!"
              exit 0
            fi
            sleep 5
          done
          echo "SQL Server did not start in time" >&2
          exit 1

      - name: Verify DB and Table
        run: |
          docker exec mssql /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'Redg@te1' -Q "USE SSC_Dev; SELECT * FROM sys.tables"
